# ğŸ” Authentication & Authorization Architecture

## Overview

This document describes the security architecture for the **Trading Platform**, focusing on how the **Auth Service** and **User Service** work together to provide secure authentication and authorization.

---

## ğŸ—ºï¸ High-Level Security Architecture

```
                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                    â”‚                        CLIENT LAYER                             â”‚
                                    â”‚              (Web App / Mobile App / Trading Terminal)          â”‚
                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                                  â”‚
                                                                  â”‚ HTTPS Request
                                                                  â”‚ + JWT Token (if authenticated)
                                                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                           API GATEWAY (Port: 8765)                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Rate Limiter   â”‚  â”‚   JWT Filter    â”‚  â”‚  Route Matcher  â”‚  â”‚   CORS Filter   â”‚  â”‚  Request Logger â”‚   â”‚
â”‚  â”‚  (Redis-based)  â”‚  â”‚  (Validation)   â”‚  â”‚   (Routing)     â”‚  â”‚   (Security)    â”‚  â”‚  (Observability)â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
â”‚                                                     â”‚                                                       â”‚
â”‚                           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚                           â”‚              SPRING CLOUD GATEWAY                 â”‚                             â”‚
â”‚                           â”‚           (Service Discovery via Eureka)          â”‚                             â”‚
â”‚                           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                      â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚                                 â”‚                                 â”‚
                    â–¼                                 â–¼                                 â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚       AUTH SERVICE        â”‚   â”‚       USER SERVICE        â”‚   â”‚     OTHER SERVICES        â”‚
    â”‚       (Port: 8081)        â”‚   â”‚       (Port: 8082)        â”‚   â”‚   (Order, Wallet, etc.)   â”‚
    â”‚                           â”‚   â”‚                           â”‚   â”‚                           â”‚
    â”‚  â€¢ Login / Register       â”‚   â”‚  â€¢ User Profile CRUD      â”‚   â”‚  â€¢ Protected Endpoints    â”‚
    â”‚  â€¢ JWT Generation         â”‚â—„â”€â”€â”¤  â€¢ KYC Management         â”‚   â”‚  â€¢ JWT Validation         â”‚
    â”‚  â€¢ Token Refresh          â”‚   â”‚  â€¢ Preferences            â”‚   â”‚  â€¢ Role-based Access      â”‚
    â”‚  â€¢ 2FA / MFA              â”‚   â”‚  â€¢ Account Management     â”‚   â”‚                           â”‚
    â”‚  â€¢ Password Reset         â”‚   â”‚                           â”‚   â”‚                           â”‚
    â”‚  â€¢ Session Management     â”‚   â”‚                           â”‚   â”‚                           â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                  â”‚                               â”‚
                  â”‚                               â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                           â”‚   â”‚                           â”‚
    â–¼                           â–¼   â–¼                           â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Redis   â”‚             â”‚PostgreSQL â”‚                   â”‚PostgreSQL â”‚
â”‚  (6379)   â”‚             â”‚  (5432)   â”‚                   â”‚  (5432)   â”‚
â”‚           â”‚             â”‚           â”‚                   â”‚           â”‚
â”‚ â€¢ Sessionsâ”‚             â”‚ â€¢ Auth DB â”‚                   â”‚ â€¢ User DB â”‚
â”‚ â€¢ Tokens  â”‚             â”‚ â€¢ Creds   â”‚                   â”‚ â€¢ Profile â”‚
â”‚ â€¢ Cache   â”‚             â”‚ â€¢ Roles   â”‚                   â”‚ â€¢ KYC     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”‘ JWT Authentication Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    JWT AUTHENTICATION FLOW                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   CLIENT                API GATEWAY              AUTH SERVICE              USER SERVICE           REDIS
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚  1. Login Request     â”‚                         â”‚                         â”‚                   â”‚
     â”‚  (email, password)    â”‚                         â”‚                         â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚  2. Route to /auth/**   â”‚                         â”‚                   â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚  3. Fetch User Details  â”‚                   â”‚
     â”‚                       â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚  4. Return User + Roles â”‚                   â”‚
     â”‚                       â”‚                         â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚  5. Validate Password   â”‚                   â”‚
     â”‚                       â”‚                         â”‚     (BCrypt Compare)    â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚  6. Generate JWT Pair   â”‚                   â”‚
     â”‚                       â”‚                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                   â”‚
     â”‚                       â”‚                         â”‚  â”‚ Access Token (15m)  â”‚â”‚                   â”‚
     â”‚                       â”‚                         â”‚  â”‚ Refresh Token (7d)  â”‚â”‚                   â”‚
     â”‚                       â”‚                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚  7. Store Refresh Token â”‚                   â”‚
     â”‚                       â”‚                         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚  8. Return JWT Tokens   â”‚                         â”‚                   â”‚
     â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚  9. JWT Response      â”‚                         â”‚                         â”‚                   â”‚
     â”‚  {accessToken,        â”‚                         â”‚                         â”‚                   â”‚
     â”‚   refreshToken}       â”‚                         â”‚                         â”‚                   â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚  10. API Request      â”‚                         â”‚                         â”‚                   â”‚
     â”‚  Authorization:       â”‚                         â”‚                         â”‚                   â”‚
     â”‚  Bearer <accessToken> â”‚                         â”‚                         â”‚                   â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚  11. Validate JWT       â”‚                         â”‚                   â”‚
     â”‚                       â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚                         â”‚                   â”‚
     â”‚                       â”‚  â”‚ â€¢ Signature Check  â”‚â”‚                         â”‚                   â”‚
     â”‚                       â”‚  â”‚ â€¢ Expiry Check     â”‚â”‚                         â”‚                   â”‚
     â”‚                       â”‚  â”‚ â€¢ Claims Extract   â”‚â”‚                         â”‚                   â”‚
     â”‚                       â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚  12. Route to Service   â”‚                         â”‚                   â”‚
     â”‚                       â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚  13. Service Response   â”‚                         â”‚                   â”‚
     â”‚                       â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
     â”‚  14. Final Response   â”‚                         â”‚                         â”‚                   â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                         â”‚                         â”‚                   â”‚
     â”‚                       â”‚                         â”‚                         â”‚                   â”‚
```

---

## ğŸ”„ Token Refresh Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                      TOKEN REFRESH FLOW                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   CLIENT                      API GATEWAY                 AUTH SERVICE                    REDIS
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚  1. Access Token Expired    â”‚                            â”‚                            â”‚
     â”‚     (401 Unauthorized)      â”‚                            â”‚                            â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚  2. POST /auth/refresh      â”‚                            â”‚                            â”‚
     â”‚  {refreshToken: "..."}      â”‚                            â”‚                            â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚  3. Route to Auth Service  â”‚                            â”‚
     â”‚                             â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                            â”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚  4. Validate Refresh Token â”‚
     â”‚                             â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚  5. Token Valid?           â”‚
     â”‚                             â”‚                            â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚  6. Generate New Token Pairâ”‚
     â”‚                             â”‚                            â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
     â”‚                             â”‚                            â”‚  â”‚ New Access Token       â”‚â”‚
     â”‚                             â”‚                            â”‚  â”‚ New Refresh Token      â”‚â”‚
     â”‚                             â”‚                            â”‚  â”‚ (Rotate for security)  â”‚â”‚
     â”‚                             â”‚                            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚  7. Invalidate Old Token   â”‚
     â”‚                             â”‚                            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚                             â”‚  8. Return New Tokens      â”‚                            â”‚
     â”‚                             â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚
     â”‚                             â”‚                            â”‚                            â”‚
     â”‚  9. New JWT Tokens          â”‚                            â”‚                            â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                            â”‚                            â”‚
     â”‚                             â”‚                            â”‚                            â”‚
```

---

## ğŸ›¡ï¸ Authorization (Role-Based Access Control)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                    ROLE-BASED ACCESS CONTROL (RBAC)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚                     JWT TOKEN                       â”‚
                         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                         â”‚  â”‚ Header                                        â”‚  â”‚
                         â”‚  â”‚ {                                             â”‚  â”‚
                         â”‚  â”‚   "alg": "RS256",                             â”‚  â”‚
                         â”‚  â”‚   "typ": "JWT"                                â”‚  â”‚
                         â”‚  â”‚ }                                             â”‚  â”‚
                         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
                         â”‚  â”‚ Payload                                       â”‚  â”‚
                         â”‚  â”‚ {                                             â”‚  â”‚
                         â”‚  â”‚   "sub": "user-uuid-123",                     â”‚  â”‚
                         â”‚  â”‚   "email": "user@example.com",                â”‚  â”‚
                         â”‚  â”‚   "roles": ["ROLE_USER", "ROLE_TRADER"],      â”‚  â”‚
                         â”‚  â”‚   "permissions": ["READ", "TRADE", "WITHDRAW"]â”‚  â”‚
                         â”‚  â”‚   "iat": 1703275200,                          â”‚  â”‚
                         â”‚  â”‚   "exp": 1703276100                           â”‚  â”‚
                         â”‚  â”‚ }                                             â”‚  â”‚
                         â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”‚
                         â”‚  â”‚ Signature (RS256)                             â”‚  â”‚
                         â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                    â”‚
                                                    â–¼
          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
          â”‚                              ROLE HIERARCHY                                   â”‚
          â”‚                                                                               â”‚
          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚
          â”‚     â”‚  ROLE_ADMIN  â”‚     â”‚ ROLE_TRADER  â”‚     â”‚  ROLE_USER   â”‚               â”‚
          â”‚     â”‚              â”‚     â”‚              â”‚     â”‚              â”‚               â”‚
          â”‚     â”‚ â€¢ All Access â”‚     â”‚ â€¢ Trade      â”‚     â”‚ â€¢ View       â”‚               â”‚
          â”‚     â”‚ â€¢ User Mgmt  â”‚     â”‚ â€¢ Withdraw   â”‚     â”‚ â€¢ Deposit    â”‚               â”‚
          â”‚     â”‚ â€¢ System Cfg â”‚     â”‚ â€¢ View       â”‚     â”‚ â€¢ Profile    â”‚               â”‚
          â”‚     â”‚ â€¢ Audit Logs â”‚     â”‚ â€¢ Deposit    â”‚     â”‚              â”‚               â”‚
          â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
          â”‚            â”‚                    â”‚                    â”‚                        â”‚
          â”‚            â–¼                    â–¼                    â–¼                        â”‚
          â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
          â”‚     â”‚                    ENDPOINT AUTHORIZATION                        â”‚      â”‚
          â”‚     â”‚                                                                  â”‚      â”‚
          â”‚     â”‚  /api/admin/**         â†’ @PreAuthorize("hasRole('ADMIN')")      â”‚      â”‚
          â”‚     â”‚  /api/orders/**        â†’ @PreAuthorize("hasRole('TRADER')")     â”‚      â”‚
          â”‚     â”‚  /api/portfolio/**     â†’ @PreAuthorize("hasRole('USER')")       â”‚      â”‚
          â”‚     â”‚  /api/users/profile    â†’ @PreAuthorize("isAuthenticated()")     â”‚      â”‚
          â”‚     â”‚  /api/public/**        â†’ permitAll()                            â”‚      â”‚
          â”‚     â”‚                                                                  â”‚      â”‚
          â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
          â”‚                                                                               â”‚
          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Auth Service & User Service Interaction

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AUTH SERVICE â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º USER SERVICE INTERACTION                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚           AUTH SERVICE               â”‚          â”‚           USER SERVICE               â”‚
â”‚                                      â”‚          â”‚                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       AuthController           â”‚  â”‚   REST   â”‚  â”‚       UserController           â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/login            â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â–ºâ”‚  â€¢ GET  /users/{id}            â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/register         â”‚  â”‚   API    â”‚  â”‚  â€¢ POST /users                 â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/refresh          â”‚  â”‚  (Feign) â”‚  â”‚  â€¢ PUT  /users/{id}            â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/logout           â”‚  â”‚          â”‚  â”‚  â€¢ GET  /users/profile         â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/verify-2fa       â”‚  â”‚          â”‚  â”‚  â€¢ POST /users/kyc             â”‚  â”‚
â”‚  â”‚  â€¢ POST /auth/reset-password   â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                      â”‚          â”‚               â”‚                      â”‚
â”‚               â–¼                      â”‚          â”‚               â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       AuthService              â”‚  â”‚          â”‚  â”‚       UserService              â”‚  â”‚
â”‚  â”‚  â€¢ validateCredentials()       â”‚  â”‚          â”‚  â”‚  â€¢ createUser()                â”‚  â”‚
â”‚  â”‚  â€¢ generateTokens()            â”‚  â”‚          â”‚  â”‚  â€¢ getUserById()               â”‚  â”‚
â”‚  â”‚  â€¢ refreshTokens()             â”‚  â”‚          â”‚  â”‚  â€¢ updateProfile()             â”‚  â”‚
â”‚  â”‚  â€¢ validateToken()             â”‚  â”‚          â”‚  â”‚  â€¢ verifyKYC()                 â”‚  â”‚
â”‚  â”‚  â€¢ revokeToken()               â”‚  â”‚          â”‚  â”‚  â€¢ getUserRoles()              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                      â”‚          â”‚               â”‚                      â”‚
â”‚               â–¼                      â”‚          â”‚               â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Repository Layer         â”‚  â”‚          â”‚  â”‚       Repository Layer         â”‚  â”‚
â”‚  â”‚  â€¢ AuthCredentialRepository    â”‚  â”‚          â”‚  â”‚  â€¢ UserRepository              â”‚  â”‚
â”‚  â”‚  â€¢ RoleRepository              â”‚  â”‚          â”‚  â”‚  â€¢ UserProfileRepository       â”‚  â”‚
â”‚  â”‚  â€¢ RefreshTokenRepository      â”‚  â”‚          â”‚  â”‚  â€¢ KYCRepository               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚               â”‚                      â”‚          â”‚               â”‚                      â”‚
â”‚               â–¼                      â”‚          â”‚               â–¼                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚   PostgreSQL + Redis           â”‚  â”‚          â”‚  â”‚        PostgreSQL              â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚          â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚   â”‚ Tables:                 â”‚  â”‚  â”‚          â”‚  â”‚   â”‚ Tables:                 â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ auth_credentials      â”‚  â”‚  â”‚          â”‚  â”‚   â”‚ â€¢ users                 â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ roles                 â”‚  â”‚  â”‚          â”‚  â”‚   â”‚ â€¢ user_profiles         â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ user_roles            â”‚  â”‚  â”‚          â”‚  â”‚   â”‚ â€¢ user_preferences      â”‚  â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ password_reset_tokens â”‚  â”‚  â”‚          â”‚  â”‚   â”‚ â€¢ kyc_documents         â”‚  â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚          â”‚  â”‚   â”‚ â€¢ user_addresses        â”‚  â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚          â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â”‚   â”‚ Redis:                  â”‚  â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ refresh_tokens:{id}   â”‚  â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ sessions:{userId}     â”‚  â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â”‚ â€¢ blacklist:{tokenId}   â”‚  â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚          â”‚  â”‚                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                      â”‚          â”‚                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                                    EUREKA (Service Discovery)
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Registered Services:            â”‚
                              â”‚  â€¢ AUTH-SERVICE    â†’ localhost:8081 â”‚
                              â”‚  â€¢ USER-SERVICE    â†’ localhost:8082 â”‚
                              â”‚  â€¢ API-GATEWAY     â†’ localhost:8765 â”‚
                              â”‚  â€¢ OTHER-SERVICES  â†’ localhost:80xx â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ” Two-Factor Authentication (2FA) Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                TWO-FACTOR AUTHENTICATION (2FA) FLOW                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

   CLIENT                      AUTH SERVICE                    EXTERNAL SERVICES
     â”‚                              â”‚                                 â”‚
     â”‚  1. Login (email, password)  â”‚                                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                 â”‚
     â”‚                              â”‚                                 â”‚
     â”‚                              â”‚  2. Validate Credentials âœ“      â”‚
     â”‚                              â”‚                                 â”‚
     â”‚                              â”‚  3. Check if 2FA Enabled        â”‚
     â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
     â”‚                              â”‚  â”‚ User has 2FA enabled?   â”‚    â”‚
     â”‚                              â”‚  â”‚         YES             â”‚    â”‚
     â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     â”‚                              â”‚                                 â”‚
     â”‚  4. Response: 2FA Required   â”‚                                 â”‚
     â”‚  {requires2FA: true,         â”‚                                 â”‚
     â”‚   tempToken: "...",          â”‚                                 â”‚
     â”‚   method: "TOTP/SMS/EMAIL"}  â”‚                                 â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
     â”‚                              â”‚                                 â”‚
     â”‚                              â”‚  5. Generate & Send OTP         â”‚
     â”‚                              â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
     â”‚                              â”‚     (SMS Gateway / Email)       â”‚
     â”‚                              â”‚                                 â”‚
     â”‚  6. Enter OTP Code           â”‚                                 â”‚
     â”‚  {tempToken, otpCode}        â”‚                                 â”‚
     â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                                 â”‚
     â”‚                              â”‚                                 â”‚
     â”‚                              â”‚  7. Validate OTP                â”‚
     â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
     â”‚                              â”‚  â”‚ â€¢ TOTP: Time-based      â”‚    â”‚
     â”‚                              â”‚  â”‚ â€¢ SMS: Code Match       â”‚    â”‚
     â”‚                              â”‚  â”‚ â€¢ Email: Code Match     â”‚    â”‚
     â”‚                              â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
     â”‚                              â”‚                                 â”‚
     â”‚  8. Full Authentication      â”‚                                 â”‚
     â”‚  {accessToken, refreshToken} â”‚                                 â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤                                 â”‚
     â”‚                              â”‚                                 â”‚
```

---

## ğŸ”’ Security Features Summary

### Authentication Mechanisms
| Feature | Description | Storage |
|---------|-------------|---------|
| **JWT Tokens** | Stateless access tokens with RS256 signing | N/A (Stateless) |
| **Refresh Tokens** | Long-lived tokens for session renewal | Redis |
| **Password Hashing** | BCrypt with strength 12 | PostgreSQL |
| **2FA/MFA** | TOTP (Google Auth) / SMS / Email | PostgreSQL + Redis |
| **Session Management** | Distributed sessions with TTL | Redis |

### Authorization Controls
| Feature | Description |
|---------|-------------|
| **RBAC** | Role-Based Access Control (ADMIN, TRADER, USER) |
| **Method Security** | @PreAuthorize annotations on endpoints |
| **Resource-Level** | User can only access own resources |
| **API Gateway Filter** | JWT validation before routing |

### Security Headers & Protections
| Protection | Implementation |
|------------|----------------|
| **CORS** | Configured allowed origins |
| **CSRF** | Disabled for stateless JWT |
| **XSS** | Content-Security-Policy headers |
| **Rate Limiting** | Redis-based sliding window |
| **Brute Force** | Account lockout after N attempts |

---

## ğŸ“Š Database Schema (Auth Service)

```sql
-- Auth Credentials Table
CREATE TABLE auth_credentials (
    id              UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id         UUID NOT NULL UNIQUE,          -- Reference to User Service
    email           VARCHAR(255) NOT NULL UNIQUE,
    password_hash   VARCHAR(255) NOT NULL,
    is_2fa_enabled  BOOLEAN DEFAULT FALSE,
    totp_secret     VARCHAR(255),
    failed_attempts INT DEFAULT 0,
    locked_until    TIMESTAMP,
    last_login      TIMESTAMP,
    created_at      TIMESTAMP DEFAULT NOW(),
    updated_at      TIMESTAMP DEFAULT NOW()
);

-- Roles Table
CREATE TABLE roles (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    name        VARCHAR(50) NOT NULL UNIQUE,
    description VARCHAR(255),
    created_at  TIMESTAMP DEFAULT NOW()
);

-- User Roles Junction Table
CREATE TABLE user_roles (
    user_id     UUID REFERENCES auth_credentials(user_id),
    role_id     UUID REFERENCES roles(id),
    granted_at  TIMESTAMP DEFAULT NOW(),
    granted_by  UUID,
    PRIMARY KEY (user_id, role_id)
);

-- Password Reset Tokens
CREATE TABLE password_reset_tokens (
    id          UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    user_id     UUID REFERENCES auth_credentials(user_id),
    token_hash  VARCHAR(255) NOT NULL,
    expires_at  TIMESTAMP NOT NULL,
    used        BOOLEAN DEFAULT FALSE,
    created_at  TIMESTAMP DEFAULT NOW()
);
```

---

## ğŸ”§ Configuration Reference

### JWT Configuration (application.yaml)
```yaml
jwt:
  secret-key: ${JWT_SECRET_KEY}
  access-token:
    expiration: 900000        # 15 minutes
  refresh-token:
    expiration: 604800000     # 7 days
  issuer: trading-platform
  
spring:
  security:
    oauth2:
      resourceserver:
        jwt:
          issuer-uri: ${AUTH_SERVICE_URL}
```

### Redis Session Configuration
```yaml
spring:
  session:
    store-type: redis
    redis:
      namespace: trading:sessions
  redis:
    host: ${REDIS_HOST}
    port: ${REDIS_PORT}
    password: ${REDIS_PASSWORD}
```

---

## ğŸš€ API Endpoints

### Auth Service Endpoints
| Method | Endpoint | Description | Auth Required |
|--------|----------|-------------|---------------|
| POST | `/auth/register` | User registration | No |
| POST | `/auth/login` | User login | No |
| POST | `/auth/refresh` | Refresh access token | Refresh Token |
| POST | `/auth/logout` | Invalidate session | Yes |
| POST | `/auth/verify-2fa` | Verify 2FA code | Temp Token |
| POST | `/auth/enable-2fa` | Enable 2FA | Yes |
| POST | `/auth/forgot-password` | Request password reset | No |
| POST | `/auth/reset-password` | Reset password with token | Reset Token |
| GET | `/auth/validate` | Validate current token | Yes |

### User Service Endpoints (Protected)
| Method | Endpoint | Description | Roles |
|--------|----------|-------------|-------|
| GET | `/users/profile` | Get current user profile | USER |
| PUT | `/users/profile` | Update profile | USER |
| POST | `/users/kyc` | Submit KYC documents | USER |
| GET | `/users/{id}` | Get user by ID | ADMIN |
| GET | `/users` | List all users | ADMIN |

---

## ğŸ› ï¸ Technology Stack

| Component | Technology |
|-----------|------------|
| **Framework** | Spring Boot 3.5.x |
| **Security** | Spring Security 6.x |
| **JWT Library** | jjwt / nimbus-jose-jwt |
| **Database** | PostgreSQL 16 |
| **Cache/Sessions** | Redis 7.x |
| **Service Discovery** | Eureka (Netflix OSS) |
| **API Gateway** | Spring Cloud Gateway |
| **Password Encoding** | BCrypt |
| **2FA (TOTP)** | Google Authenticator compatible |

---

## ğŸ“ Security Best Practices Implemented

1. **Token Security**
   - Short-lived access tokens (15 min)
   - Refresh token rotation on use
   - Token blacklisting on logout

2. **Password Security**
   - BCrypt hashing (cost factor 12)
   - Password complexity requirements
   - Account lockout after failed attempts

3. **Communication Security**
   - HTTPS enforced
   - Secure cookie flags (HttpOnly, Secure, SameSite)
   - CORS whitelist

4. **Defense in Depth**
   - Gateway-level JWT validation
   - Service-level authorization
   - Database-level encryption at rest

---

## ğŸ“š Related Documentation

- [Main README](../../README.md)
- [API Gateway README](../api-gateway/README.md)
- [User Service Documentation](../user-service/README.md)

---

*Last Updated: December 2024*

